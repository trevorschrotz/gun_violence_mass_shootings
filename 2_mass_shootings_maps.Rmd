---
title: "Mass Shooting Gun Violence in the United States of America"
subtitle: "Maps and Geographic Analysis"
author: "Trevor Schrotz"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    theme: lumen
    df_print: paged
    code_folding: hide
    toc: true
    toc_depth: 4
    toc_float: true
editor_options:
  chunk_output_type: inline
---

<style type="text/css">
.main-container {
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Introduction

## Preface

This is part two in a look at gun violence mass shootings in the US.  In this analysis, we will look at the shooting incident data geographically.

# Setup

## Load Libraries

```{r, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
library(tidytext)
library(lubridate)
library(scales)
library(janitor)
library(skimr)
library(tidyquant)
library(broom)
library(purrr)
library(rvest)
library(tidycensus)
library(tidygeocoder)
library(leaflet)
library(reticulate)
pd <- py_install("pandas")
api_key <- Sys.getenv("CENSUS_API_KEY")
```

# Source the data

Read in the saved data file.

```{r, include=TRUE}
complete_tbl <- read_rds("gva_data.rds") 
```

Here I prepare the primary data set to include some date-related fields for convenience when plotting and summarizing the data.

```{r cleaning, include=TRUE}
ms_tbl <- complete_tbl %>% 
    janitor::clean_names() %>% 
    select(-operations) %>% 
    mutate(incident_date = mdy(incident_date),
           year = year(incident_date),
           month = month(incident_date, label = T, abbr = T),
           incident_month = rollforward(incident_date),
           dow = wday(incident_date, label = TRUE)) %>% 
    arrange(incident_date)
```

# Pull the incident IDs from the GVA data which then become part of the URL for the incident-specific information.

```{r}
incident_ids <- ms_tbl %>%
    distinct(incident_id)

geo_locations_incidents_tbl <- incident_ids %>%
    mutate(pages = str_glue("https://www.gunviolencearchive.org/incident/{incident_id}"))
```


```{python}

# run these in terminal
# pip install selenium
# pip install chromedriver
# pip install beautifulsoup4

from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from bs4 import BeautifulSoup
import pandas as pd

options = Options()
options.add_experimental_option("excludeSwitches", ["enable-automation"])
options.add_argument('--disable-blink-features=AutomationControlled')
options.add_argument("--profile-directory=Default")
options.add_argument("--user-data-dir=C:/Users/trevorschrotz/AppData/Local/Google/Chrome/User Data")
options.add_experimental_option("useAutomationExtension", False)

driver = webdriver.Chrome(options=options)
first_page = "https://www.gunviolencearchive.org/reports/mass-shooting?year=2019"
driver.get(first_page) 
soup = BeautifulSoup(driver.page_source, 'html.parser')

pd.read_html(BeautifulSoup(driver.page_source, 'html.parser'))

soup.select(selector="Location")
soup.select_one('h2:-soup-contains("Location")').find_next('table')
soup.find('h2',text='Location').text


```



# Mapping

```{r get geoloc, eval=FALSE}
# Incident Map
# get a list of unique cities and states;
# this reduces our list down to ~1090 vs ~3840, which will take about 18 minutes to geocode vs 50 minutes

unique_city_state <- ms_tbl %>%
    mutate(city_or_county = str_remove_all(city_or_county, "\\(.*\\)")) %>%
    distinct(city_or_county, state)

ms_lat_longs_nest <- unique_city_state %>%
    mutate(group_state = state) %>%
    group_by(group_state) %>%
    nest(data = -group_state) %>%
    mutate(mapper = map(.x = data, .f = function(data) { data %>%
                                                             geocode(city = city_or_county,
                                                         state = state,
                                                         method = 'osm',
                                                         lat = latitude ,
                                                         long = longitude) }))

ms_lat_longs <- ms_lat_longs_nest %>%
    unnest(mapper) %>%
    ungroup() %>%
    select(-group_state, -data) %>%
    inner_join(ms_tbl %>%
                   mutate(city_or_county = str_remove_all(city_or_county, "\\(.*\\)")),
               by = c("city_or_county","state"))

#save it so we don't have to re-run this every session

write_rds(x = ms_lat_longs, "ms_lat_longs.rds")
```

```{r load map data, include=TRUE, eval=TRUE}
ms_lat_longs <- read_rds("ms_lat_longs.rds")
```

```{r simple map, include=TRUE, eval=TRUE, message=FALSE, warning=FALSE, out.width="100%", out.height="100%"}
library(gganimate)

ms_lat_longs %>% 
    mutate(year = factor(year)) %>% 
    filter(state != "Alaska") %>% 
    ggplot(aes(jitter(longitude, 0.005), jitter(latitude, 0.005), 
               size = number_killed + number_injured,
               color = year)) +
    geom_point() +
    borders("state") +
    scale_color_tq() +
    coord_map() +
    theme_light() +
    labs(title = "Map of Mass Shooting Incidents in {closest_state}",
         subtitle = "Size represents the total deaths and injuries per incident",
         x = "",
         y = "") +
    theme(legend.position = "none") +
    transition_states(year, transition_length = 1, state_length = 1) +
    enter_fade() +
    exit_fade()
```

```{r map, include=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# List the available map tiles
#names(providers)

# Create a leaflet map with default map tile using addTiles()
ms_lat_longs %>%
    leaflet() %>%
    addProviderTiles("CartoDB") %>%
    addCircleMarkers(lng = ~jitter(longitude, amount = 0.05), lat = ~jitter(latitude, amount = 0.05),
                     label = lapply(str_glue("{month(ms_lat_longs$incident_date, label = TRUE, abbr = TRUE)} {year(ms_lat_longs$incident_date)} <br/> {ms_lat_longs$city_or_county}, {ms_lat_longs$state} <br/> {ms_lat_longs$number_killed} killed | {ms_lat_longs$number_injured} wounded"), htmltools::HTML), radius = 3, color = "steelblue", clusterOptions = markerClusterOptions()) %>%
    addProviderTiles("CartoDB", group = "CartoDB") %>%
    addProviderTiles("Esri", group = "Esri") %>%
    addLayersControl(baseGroups = c("Esri","CartoDB")) # Use addLayersControl to allow users to toggle between basemaps
```

```{r future scrape, include=FALSE, eval=FALSE}
#Scraping Incident Details - come back to this later - getting a 503 error...
incident_ids <- ms_tbl %>%
    distinct(incident_id)

geo_locations_incidents_tbl <- incident_ids %>%
    mutate(pages = str_glue("https://www.gunviolencearchive.org/incident/{incident_id}"))

geo_scrape <- geo_locations_incidents_tbl %>%
    mutate(scrape = map(.x = pages, .f = ~read_html(.x)))

geo_locations_tbl <- map_df(geo_scrape$scrape, ~ html_table(.x))

url <- "https://www.gunviolencearchive.org/incident/465117"

test <- httr::GET(url) %>% `$`("content")

test$status_code

test$content

test %>% xml2::read_html() %>% rvest::html_table()


# https://callumgwtaylor.github.io/post/using-rselenium-and-docker-to-webscrape-in-r-using-the-who-snake-database/
# https://www.youtube.com/watch?v=Dkm1d4uMp34
library(RSelenium)
library(netstat)
# docker run -d -p 4445:4444 selenium/standalone-chrome
# docker ps
# open chrome, type chrome://version/ and find the version
# next use binman below to find closest / latest version based upon first digits

url <- "https://www.gunviolencearchive.org/incident/465117"
exCap <- list("moz::firefoxOptions" = list(args = list('--headless')))
rD <- rsDriver(browser = "firefox", 
               extraCapabilities = exCap, 
               port = 1111L, 
               verbose = FALSE)

remDr <- rD$client

remDr$open()

remDr$navigate(url)


remDr <- remoteDriver(browser = "sharp_wright", port = 4445L)

remDr$open()
remDr$navigate("https://www.gunviolencearchive.org/incident/225830")

# Using Docker
remDr <- remoteDriver(port = 4445L)

remDr$open()
remDr$errorDetails()

remDr$navigate("https://www.gunviolencearchive.org/incident/225830")

# Using RSelenium Directly
binman::list_versions("chromedriver")

eCaps <- list(chromeOptions = list(args = list("--headless","--disable-infobars",
                                               "--excludeSwitches","--useAutomationExtension = FALSE",
                                               "--enable-automation"))) #

rs_driver_object <- rsDriver(browser = "chrome", 
                             chromever = "105.0.5195.52", 
                             verbose = FALSE, 
                             port = netstat::free_port(), 
                             extraCapabilities = eCaps)

remDr <- rs_driver_object$client

asdf <- remDr$navigate(url = url)

remDr$screenshot(file = asdf, display = TRUE)
    

# https://github.com/trevorschrotz/gun_violence_mass_shootings.git
```