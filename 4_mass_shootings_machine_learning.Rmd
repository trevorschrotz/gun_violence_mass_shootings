---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Load Libraries

```{r, include=TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(tidymodels)
library(tidytext)
library(lubridate)
library(scales)
library(janitor)
library(tictoc)
library(future)
library(doFuture)
library(tidyquant)
library(leaflet)

registerDoFuture()

n_cores <- parallel::detectCores()

plan(strategy = cluster,
     workers  = parallel::makeCluster(n_cores))
```

# Prepare Data

```{r}
ml_data <- read_rds("ms_tbl_updated_geo_locs.rds")

ml_prep <- ml_data %>% 
    rename("GeoLocation" = geo_data) %>% 
    mutate(temp = GeoLocation,
           temp = str_remove_all(temp, "Geolocation: "),
           number_casualties = number_killed + number_injured) %>% 
    separate(temp, into = c("latitude","longitude"), sep = ", ") %>% 
    mutate(across(latitude:longitude, ~ as.numeric(.)),
           city_or_county = str_trim(str_remove_all(city_or_county, "\\(.*\\)")))
```

# Filter Down to One State and Process EDA

Time is certainly a variable with mass shootings in Illinois, and we don't want date or year to play a role in the model because ideally we want to help identify when and where a mass shooting incident might occur given some inputs, but looking back in time isn't helpful here.

```{r}
ml_prep %>% 
    filter(state == "Illinois") %>% 
    filter(incident_month < floor_date(Sys.Date(), "month")) %>% 
    ggplot(aes(incident_month, number_casualties)) +
    stat_summary(geom = "bar", fun = sum, fill = "steelblue", color = "gray30", alpha = 0.9) +
    scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
    theme_tq() +
    scale_color_tq() +
    labs(title = "Number of Mass Shooting Incidents by Month and Year",
         subtitle = str_glue("From {min(ml_prep$incident_date)} through {max(ml_prep %>% filter(incident_month < floor_date(Sys.Date(), 'month')) %>% pull(incident_date))}"),
         x = "Month",
         y = "",
         caption = str_glue("Current incomplete month removed."))
```

Let's try looking at 2020 forward in the "new normal" range.  I think this looks better and it mitigates the impact of time somewhat on the variability of the data year over year.

```{r}
ml_prep %>% 
    filter(state == "Illinois",
           year >= 2020) %>% 
    filter(incident_month < floor_date(Sys.Date(), "month")) %>% 
    ggplot(aes(incident_month, number_casualties)) +
    stat_summary(geom = "bar", fun = sum, fill = "steelblue", color = "gray30", alpha = 0.9) +
    scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
    theme_tq() +
    scale_color_tq() +
    labs(title = "Number of Mass Shooting Incidents by Month and Year",
         subtitle = str_glue("From {min(ml_prep$incident_date)} through {max(ml_prep %>% filter(incident_month < floor_date(Sys.Date(), 'month')) %>% pull(incident_date))}"),
         x = "Month",
         y = "",
         caption = str_glue("Mass shooting defined as four or more victims not including perpetrator(s).
                             Current incomplete month removed."))  
```

# Feature Selection and EDA

Very similar patterns in months and days of the week that we saw in the aggregate data analysis

```{r}
ml_illinois <- ml_prep %>% 
    filter(state == "Illinois",
           year >= 2020,
           incident_month < floor_date(Sys.Date(), "month")) %>% 
    select(-c(incident_date, year, number_killed, number_injured, GeoLocation, address, incident_month))

ml_illinois %>% 
    ggplot(aes(month, number_casualties)) +
    stat_summary(geom = "bar", fun = sum)

ml_illinois %>% 
    ggplot(aes(dow, number_casualties)) +
    stat_summary(geom = "bar", fun = sum)
```

The majority of mass shootings occur in the Chicago area with outliers throughout the state.

```{r}
ml_illinois %>% 
    leaflet(height = 1000, width = 1000) %>%
    addProviderTiles("Stamen.Toner") %>% 
    addCircleMarkers(radius = 3, color = "blue", clusterOptions = markerClusterOptions()) %>% 
    setView(lng = -87, lat = 35,  zoom = 6)
```

# The Question - Given the time and locaiton data we have, can we provide insights into when and where mass shootings might occur?  Would this prediction be helpful to police and communities in an effort to prevent these events from happening?  Let's start with a tree based model and see what that yields.

```{r}
ml_chicago <- ml_illinois %>% 
    mutate(month = as.character(month),
           dow = as.character(dow)) %>% 
    filter(city_or_county == "Chicago") %>% 
    select(-latitude, -longitude)
```


# Split Data into Training and Testing Sets with Additional Cross-Fold Validation

```{r}
set.seed(1975)

illinois_split <- ml_chicago %>% 
    initial_split(prop = 0.8, strata = number_casualties)

illinois_train <- training(illinois_split)

illinois_test <- testing(illinois_split)

illinois_vfolds <- vfold_cv(illinois_train)
```

# Create a Tree-Based Tidymodels ML Recipe

```{r}
illinois_tree_recipe <- 
    recipe(number_casualties ~ ., data = illinois_train) %>% 
    update_role(incident_id, new_role = "id") %>% 
    update_role(state, new_role = "id") %>% 
    update_role(city_or_county, new_role = "id") %>% 
    step_other(month, threshold = 0.05) %>% 
    step_dummy(all_nominal_predictors())

illinois_tree_recipe %>% 
    prep() %>% 
    bake(new_data = illinois_train)
```


```{r}
xgboost_spec <- boost_tree(trees = tune(), min_n = tune(), tree_depth = tune(), learn_rate = tune()) %>% 
    set_engine("xgboost") %>% 
    set_mode("regression")

xgboost_workflow <- workflow() %>% 
    add_recipe(illinois_tree_recipe) %>% 
    add_model(xgboost_spec) 

set.seed(1984)

xg_tune_grid <- grid_random(trees(), min_n(), tree_depth(), learn_rate(), size = 10)

xgboost_tune <- tune_grid(xgboost_workflow, resamples = illinois_vfolds, grid = xg_tune_grid)

xgboost_tune %>% show_best()

best_xg <- xgboost_tune %>% 
    select_best(metric = "rmse")

final_xg_workflow <- xgboost_workflow %>% 
    finalize_workflow(best_xg)

xg_wf_fit <- final_xg_workflow %>% 
             fit(data = illinois_train)

xg_fit <- xg_wf_fit %>% 
    extract_fit_parsnip()

vip::vip(xg_fit)
```







